name: Deploy Flutter Web to VPS

on:
  push:
    branches:
      - main  # Change this to your deployment branch

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Install Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: "3.x"  # Set your Flutter version

      - name: Build Flutter Web
        run: |
          flutter config --enable-web
          flutter build web --release

      - name: Upload web.zip to VPS
        run: |
          cd build/web
          zip -r web.zip .  # Create zip from built files
          scp web.zip ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:/www/wwwroot/logiculas.me/public-flutter/

      - name: SSH into VPS and Deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.VPS_HOST }}
          username: ${{ secrets.VPS_USER }}
          password: ${{ secrets.VPS_PASSWORD }}
          script: |
            cd /www/wwwroot/logiculas.me/public-flutter || exit 1
            echo "Checking if web.zip exists..."
            if [ -f "web.zip" ]; then
              echo "web.zip found, proceeding with deployment."
              rm -rf assets canvaskit icons *.js *.json *.html *.png  # Delete old files safely
              unzip -o web.zip
              rm web.zip
              echo "Deployment completed successfully."
            else
              echo "Error: web.zip not found!"
              exit 1
            fi
